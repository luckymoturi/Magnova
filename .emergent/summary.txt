<analysis>**original_problem_statement:**
You are a senior enterprise software architect and full-stack engineer building a secure, audit-ready, IMEI-level inventory, procurement, and sales management system for two related organizations: Magnova Exim Pvt. Ltd. (Export sales) and Nova Enterprises (Domestic procurement). The system must provide end-to-end visibility from Purchase Order to Sales, with detailed modules for PO Management, Procurement, complex Payment flows, IMEI Lifecycle Tracking, Logistics, Invoicing, Sales, and Reporting.

**PRODUCT REQUIREMENTS:**
- **Architecture:** Modular, service-based with centralized IMEI master, RBAC, and full audit trails.
- **Core Modules:** PO Management, Procurement, Payment Management, Inventory & IMEI Tracking, Logistics, Invoicing, Sales, and Reporting.
- **User Requests in this session:**
    - The application must be fully interconnected and feel like a real-time system.
    - Data entry or deletion in one module should instantly reflect across all other relevant modules and dropdowns.
    - Implement a sequential notification workflow: PO Created → Internal Payment → External Payment → Procurement → Logistics → Inventory → Invoice.
    - The Payments page should be accessible only by admin users.
    - Update the Reports page columns and add an Excel export feature that mirrors the on-screen view.
    - Remove the IMEI column and Colour field from the Purchase Order page and forms.
    - Make Pickup Location and To Location in the Logistics shipment form manually editable.
    - On the Procurement page, filter records based on a searched IMEI.
    - Handle comma-separated IMEI numbers as individual items throughout the entire application lifecycle (Procurement, Inventory, Invoice, Reports).
    - On the Payments page, when CC is selected for Payee Type, an additional Payee Phone Number field should appear.
    - On the Logistics page, the default shipment status should be In Transit, and the Pending option should be removed.

**User's preferred language**: English

**what currently exists?**
A full-stack application (FastAPI backend, React frontend, MongoDB) with a comprehensive set of interconnected modules for managing procurement and sales. In the last session, the application was significantly enhanced to feel more real-time by implementing a complex, app-wide notification system using React Context. This system guides users through the entire workflow from Purchase Order creation to Invoicing.

Numerous UI/UX and functionality updates were also completed based on specific user requests, including a major overhaul of the Reports page, changes to the Purchase Order, Logistics, and Procurement pages, and an initial implementation to handle multiple IMEIs from a single input. The database was also wiped clean multiple times at the user's request.

**Last working item**:
- **Last item agent was working:** The user provided a new set of requests. The agent was about to start implementing them.
    1.  **Payments Page:** Add a Payee Phone Number field that appears conditionally when the Payee Type is CC.
    2.  **Logistics Page:** Change the default shipment status to In Transit and remove the Pending status option.
- **Status:** NOT STARTED
- **Agent Testing Done:** N
- **Which testing method agent to use?** both
- **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1:** Implement Payments and Logistics page changes (Priority: P0)
-   **Issue 2:** Complete and verify the multi-IMEI handling feature (Priority: P1)
-   **Issue 3:** Refactor the monolithic  file (Priority: P1, Technical Debt)
-   **Issue 4:** The implemented notification system is not persistent (Priority: P2)
-   **Issue 5:** Frontend compiles with  warnings (Priority: P2)

**Issues Detail:**
-   **Issue 1:** Implement Payments and Logistics page changes
    -   **Attempted fixes:** None.
    -   **Next debug checklist:**
        1.  Modify  to add a Payee Phone Number input field.
        2.  Use conditional rendering to show this new field only when the Payee Type dropdown is set to CC.
        3.  Modify  to change the default status in the Create Shipment form to In Transit.
        4.  Remove Pending from the status dropdown options in the same form.
    -   **Why fix this issue and what will be achieved with the fix?** To fulfill the user's latest feature requests for improved data capture and workflow.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on other issue:** None

-   **Issue 2:** Complete and verify the multi-IMEI handling feature
    -   **Attempted fixes:** The  was updated to split comma-separated IMEIs from the input field and create a separate procurement record for each IMEI via a loop of API calls. The input label was updated.
    -   **Next debug checklist:**
        1.  Verify that when multiple IMEIs are entered in procurement, separate records are correctly created in the  collection.
        2.  Ensure that each IMEI appears as a distinct line item on the Invoices page.
        3.  Confirm that the Reports page and its Excel export show each IMEI as a separate record/row.
        4.  Perform an end-to-end test: Procure with multiple IMEIs, check inventory, create an invoice, and verify the master report.
    -   **Why fix this issue and what will be achieved with the fix?** This is a critical business requirement to track each device individually from procurement to sale.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** None

-   **Issue 3:** Refactor 
    -   **Attempted fixes:** None in this session.
    -   **Next debug checklist:**
        1.  Create directories: , .
        2.  Move Pydantic models from  into files within .
        3.  Move API endpoints into separate files in  using .
        4.  Update the main  to import and include the new routers.
    -   **Why fix this issue and what will be achieved with the fix?** To improve maintainability, readability, and scalability of the backend codebase.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** None

-   **Issue 4:** The implemented notification system is not persistent
    -   **Attempted fixes:** A comprehensive notification system was built using React Context ().
    -   **Next debug checklist:**
        1.  Design a backend model for storing notifications (e.g., , , , , ).
        2.  Create API endpoints to create, fetch, and mark notifications as read.
        3.  Refactor the frontend to fetch notifications from the backend instead of relying solely on context.
        4.  Update the  to manage notifications fetched from the server.
    -   **Why fix this issue and what will be achieved with the fix?** The current implementation loses notifications on page reload, which undermines the reliable, real-time user requirement. A persistent system is needed.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** None

-   **Issue 5:** Frontend compiles with  warnings
    -   **Attempted fixes:** None. The agent has noted the warnings but not addressed them.
    -   **Next debug checklist:**
        1.  Run yarn run v1.22.22
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command. and identify all  warnings.
        2.  For each warning, analyze the  or  hook and add the missing dependencies to the dependency array.
        3.  Ensure that adding the dependencies does not introduce infinite loops or unwanted side effects.
    -   **Why fix this issue and what will be achieved with the fix?** To adhere to React best practices and prevent potential stale state bugs.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on other issue:** None

**In progress Task List**:
-   **Task 1:** Implement Payments and Logistics page changes
    -   **Where to resume:** Start by modifying  and .
    -   **What will be achieved with this?** The application will meet the user's latest requirements.
    -   **Status:** NOT STARTED
    -   **Should Test frontend/backend/both after fix?** frontend
    -   **Blocked on something:** None

-   **Task 2:** Complete and verify the multi-IMEI handling feature
    -   **Where to resume:** Perform end-to-end testing of the multi-IMEI flow, starting from procurement. The frontend logic for splitting IMEIs is in .
    -   **What will be achieved with this?** Core business logic for tracking individual items will be correctly implemented.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on something:** None

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
  - **(P1)** Refactor the monolithic  into a modular structure.
  - **(P1)** Implement detailed IMEI Lifecycle Tracking: Enhance the UI for scanning and updating IMEI statuses (e.g., Inward Nova, Outward Nova).
  - **(P1)** Implement Logistics Document Uploads: Add functionality to upload and link E-way bills and PODs to shipments.
- **Future Tasks:**
  - Implement configurable PO approval workflows.
  - Build out more specific, granular reports.
  - Implement a full, immutable audit trail for all critical transactions.
  - Make the notification system persistent by storing notifications in the database.

**Completed work in this session**
- **Full Notification Workflow:** Implemented an app-wide, sequential notification system using React Context that guides users from PO creation through to Invoicing.
- **Role-Based Access:** Restricted the Payments page to  users only.
- **Reports Page Overhaul:**
    - Restructured columns and headers as per user's image (, ).
    - Added a new  section.
    - Implemented a new backend endpoint () and a frontend button to export the complete report view to an Excel () file.
- **Inventory Page Fix:** Updated the backend model and frontend page to correctly display , , and  for inventory items.
- **Purchase Order Page Updates:**
    - Removed the IMEI column from the main table.
    - Removed the Colour field and column from the create, view, and line-item components.
- **Logistics Page Updates:** Changed the Pickup Location and To Location fields from dropdowns to editable text inputs in the 'Create Shipment' dialog.
- **Procurement Page Updates:**
    - Added an Search by IMEI input to filter the records table.
    - Implemented logic to split comma-separated IMEIs into individual procurement records.
- **Data Management:** Cleared all transactional data from the database multiple times as requested by the user, while preserving user accounts.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1:** The notification system is not persistent.
    -   **Debug checklist:** The agent noted this limitation, acknowledging that the React Context state resets on page reloads. The next step is to implement a backend persistence layer for notifications.
    -   **Why to solve this issue and what will be achieved with this?** To create a truly reliable system where users don't lose important workflow notifications if they refresh the page.
    -   **Should Test frontend/backend/both after fix:** both
    -   **Is recurring issue?** N

-   **Issue 2:** The frontend application compiles with  warnings.
    -   **Debug checklist:** The agent noted the warnings but prioritized functional changes. These warnings should be addressed by adding the suggested dependencies to the dependency arrays in the respective hooks.
    -   **Why to solve this issue and what will be achieved with this?** To eliminate potential bugs related to stale closures and follow React best practices.
    -   **Should Test frontend/backend/both after fix:** frontend
    -   **Is recurring issue?** Y

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork:** The  file remains a monolith, and  warnings persist.
-   **Recurrence count:** 2+
-   **Status:** NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Backend:** FastAPI, Pydantic
-   **Frontend:** React, Tailwind CSS, Shadcn UI
-   **Database:** MongoDB
-   **State Management:** React Hooks (, ), React Context for global state and event-driven notifications ().
-   **Data Handling:** Client-side filtering, conditional rendering, dynamic forms.

**key DB schema**
-   **IMEIInventory (Pydantic Model):** The response model in  was updated to include , , and  to ensure these fields are sent to the frontend.

**changes in tech stack**
- None.

**All files of reference**
-   : Created and heavily modified to manage the app-wide notification and data refresh system.
-   : Modified to wrap the application with .
-   : Almost all page components were significantly modified to integrate with the  for receiving and triggering notifications.
-   : Heavily modified to add the Excel export button, update column headers, and display new data sections.
-   : Modified to handle multi-IMEI entry and add a search filter.
-   : Modified to remove the Colour and IMEI fields.
-   : Modified to make location fields editable.
-   : Modified to be admin-only and integrate with the notification workflow.
-   : Modified to update the  model and add the new  endpoint.

**Areas that need refactoring**:
-   ****: This remains the highest priority for refactoring. It's a large monolith that hinders development and maintenance.
-   ****: The notification logic should be refactored to use a persistent backend store instead of relying solely on in-memory React context state.

**key api endpoints**
-   : **(New)** Downloads a comprehensive Excel file of the master report, matching the on-screen view with all columns and data.

**Critical Info for New Agent**
-   The user wants a highly reliable, interconnected application that behaves like a real-time system. Data consistency and workflow continuity are paramount.
-   The notification system is central to the user's vision. However, its current implementation is **not persistent** and will lose state on page reloads. This is a major limitation that should be addressed soon.
-   The multi-IMEI feature (splitting comma-separated values into individual records) has been started on the frontend () but requires **thorough end-to-end verification** across Inventory, Invoices, and Reports to be considered complete.
-   The user provides very specific, frequent feedback. Pay close attention to their requests, including visual details from images.
-   The next immediate tasks are the small but specific changes requested for the Payments and Logistics pages.

**documents and test reports created in this job**
-   
-   
-   

**Last 10 User Messages and any pending HUMAN messages**
1.  **Request (New):** On the Payments page, add a Payee Phone Number field when CC is selected. On the Logistics page, default status to In Transit and remove Pending.
2.  **Request (In Progress):** When entering multiple comma-separated IMEIs, treat each as a separate product throughout the system (Inventory, Invoice, Reports).
3.  **Request (Completed):** Remove the Colour field completely from the Purchase Order page and related forms.
4.  **Request (Action Taken):** Clear all data from the database.
5.  **Request (Completed):** Implement a complete, sequential notification workflow across all modules (PO -> Payment -> Procurement -> Logistics -> Inventory -> Invoice) and make the Payments page admin-only.
6.  **Question:** what is the error - Agent investigated and found no server/compiler errors.
7.  **Request (Completed):** The Inventory page is missing brand and colour. The report export to Excel must contain all columns exactly as shown on the screen.
8.  **Suggestion (From Agent):** Ask user if they want to add a feature to back-fill missing Brand/Model/Colour for existing inventory. (No user response).
9.  **Request (Completed):** Implement four changes: Remove IMEI from PO page, make Logistics locations editable, create a notification from Procurement to Logistics, and add an IMEI search filter to the Procurement page.
10. **Request (Action Taken):** Clear all data from the database.

**Project Health Check:**
-   **Broken:**
    -   The multi-IMEI feature is only partially implemented and not verified end-to-end.
    -   The core notification system is not persistent across page reloads, which fails the user's reliability requirement.
-   **Mocked:** The  page and its associated functionality are likely still placeholders.

**3rd Party Integrations**
-   None.

**Testing status**
-   **Testing agent used after significant changes:** YES. The agent ran the testing agent multiple times after major feature implementations, consistently achieving 100% pass rates on the tests performed.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None in this session.
-   **Known regressions:** The  warning persists. The new notification system, while functional in-session, is a regression in reliability compared to a persistent solution.

**Credentials to test flow:**
-   **Magnova Admin (Full Access):**  / 
-   **Nova Stores (Procurement/Inventory):**  / 

**What agent forgot to execute**
-   The agent has not yet started implementing the latest user request regarding the Payee Phone Number field on the Payments page and the status change on the Logistics page.
-   The agent implemented the frontend logic for splitting multiple IMEIs on the Procurement page but did not follow through with end-to-end testing to ensure the change propagates correctly to Inventory, Invoices, and Reports.
-   The agent identified that the notification system is not persistent but did not create a formal task or plan to fix it, leaving it as a known limitation.</analysis>
