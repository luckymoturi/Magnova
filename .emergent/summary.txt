<analysis>**original_problem_statement:**
You are a senior enterprise software architect and full-stack engineer building a secure, audit-ready, IMEI-level inventory, procurement, and sales management system for two related organizations: Magnova Exim Pvt. Ltd. (Export sales) and Nova Enterprises (Domestic procurement). The system must provide end-to-end visibility from Purchase Order to Sales, with detailed modules for PO Management, Procurement, complex Payment flows, IMEI Lifecycle Tracking, Logistics, Invoicing, Sales, and Reporting.

**PRODUCT REQUIREMENTS:**
- **Architecture:** Modular, service-based with centralized IMEI master, RBAC, and full audit trails.
- **Core Modules:**
    1.  **PO Management:** Creation, approval workflows, status tracking.
    2.  **Nova Procurement:** Procure against POs, capture vendor/IMEI details.
    3.  **Payment Management:** Handle complex multi-party payments (Magnova -> Nova, Nova -> Vendor, Nova -> 3rd party) with split payment support.
    4.  **Inventory & IMEI Tracking:** IMEI-level scanning (inward/outward) and status flow (Procured -> Inward Nova -> ... -> Sold).
    5.  **Logistics:** E-way bill uploads, shipment tracking.
    6.  **Invoicing:** Generate invoices for different transaction legs.
    7.  **Sales Management:** Sales orders for export agencies, IMEI reservation.
    8.  **Reporting & Audit:** Comprehensive reports and immutable logs.
- **Security:** Role-based access, data segregation, Maker-Checker controls.
- **Tech Stack:** Relational database (implemented with MongoDB), API-driven design, mobile-friendly UI.

**User's preferred language**: English

**what currently exists?**
A full-stack application (FastAPI backend, React frontend, MongoDB) with a highly functional set of interconnected modules. The system supports a complete workflow from Purchase Order creation to Invoicing.

Key features implemented in the last session include:
- **Admin-Only Deletion:** A Delete button (trash icon) is present on every data table (, , , , , , ) and is only visible to admin users.
- **Overhauled Payments Module:**
    - Supports Internal (Magnova -> Nova) and External (Nova -> Vendor/CC) payment types.
    - The External payment form dynamically changes fields based on payee type (Vendor or Credit Card).
    - Logic is in place to prevent external payment totals from exceeding the internal payment for a given PO.
    - Clicking a PO number in the Internal payments table opens a modal showing all linked external payments for that PO.
- **Intelligent IMEI Inventory:**
    - Entering an IMEI number on the Inventory page triggers a lookup.
    - If the IMEI exists in procurement, vendor details, location, brand, model, and color are all auto-populated.
- **Revamped Invoicing:**
    - The invoice creation form is now fully manual, with auto-calculation for GST based on selectable percentages (5%, 12%, 18%).
    - Clicking on a created invoice number displays a professional, printable invoice template with all necessary details.
- **UI/UX Improvements:** The sidebar navigation has been reordered, Sales Orders has been removed, and various UI elements have been restyled to use orange/black instead of yellow/amber.
- **Data Integrity (In Progress):** Logic to cascade-delete related records when a Purchase Order is deleted has been added to the backend. The frontend now shows a confirmation dialog detailing what will be deleted.

**Last working item**:
- **Last item agent was working:** The agent was implementing a critical user request for data integrity and a more real-time feel. It successfully added cascade-delete logic to the  backend endpoint and updated the frontend to show a confirmation dialog with counts of related records. The agent was about to modify the  to add auto-refreshing statistics to provide real-time updates on key metrics.
- **Status:** IN PROGRESS
- **Agent Testing Done:** N (The cascade delete feature has not been fully tested)
- **Which testing method agent to use?** both (Backend for cascade logic, Frontend for UI updates and confirmation dialog)
- **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1:** Complete the data integrity and real-time update feature. (Priority: P0)
-   **Issue 2:** The monolithic  file is extremely large and complex, making maintenance difficult. (Priority: P1, Technical Debt)
-   **Issue 3:** The frontend application compiles with non-critical  warnings. (Priority: P2)

**Issues Detail:**
-   **Issue 1:** Complete Data Integrity & Real-Time Updates
    -   **Attempted fixes:** The backend  endpoint was updated to delete linked documents in , , , and . The  frontend was updated to show a confirmation dialog before deletion.
    -   **Next debug checklist:**
        1.  Modify  to fetch and display key application stats (e.g., total POs, total payments) and set it to auto-refresh periodically (e.g., every 30 seconds).
        2.  Verify that after a PO is deleted, the data is removed from all related pages (, , etc.) upon page refresh.
        3.  Ensure that all dropdowns that list POs are updated across the application after a PO is deleted to prevent selection of non-existent data.
        4.  Perform an end-to-end test: create a PO, add procurement, payments, and logistics for it, then delete the PO and confirm all related data is gone and the dashboard/dropdowns are updated.
    -   **Why fix this issue and what will be achieved with the fix?** To make the application reliable and behave like a real-time system, ensuring data consistency across all modules and preventing orphaned records.
    -   **Status:** IN PROGRESS
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on other issue:** None

-   **Issue 2:** Refactor 
    -   **Attempted fixes:** None.
    -   **Next debug checklist:**
        1.  Create a new directory structure: , , .
        2.  Move Pydantic models from  to files within .
        3.  Move API endpoint definitions from  into separate files in  using .
        4.  Refactor the main  to import and include the new routers.
    -   **Why fix this issue and what will be achieved with the fix?** To improve maintainability, readability, and scalability of the backend codebase. This is a critical technical debt item.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** backend
    -   **Blocked on other issue:** None

**In progress Task List**:
-   **Task 1:** Complete Data Integrity & Real-time Update Feature
    -   **Where to resume:** Modify  to add auto-refreshing statistics.
    -   **What will be achieved with this?** The application will feel more responsive and reliable, with data consistency maintained across all modules, especially after delete operations.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** both
    -   **Blocked on something:** None

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
  - **(P0)** Refactor the monolithic  into a modular structure.
  - **(P1)** Implement detailed IMEI Lifecycle Tracking: Enhance the UI and backend logic for scanning and updating IMEI statuses at different stages (e.g., Inward Nova, Outward Nova, Inward Magnova).
  - **(P1)** Implement Logistics Document Uploads: Add functionality to upload and link E-way bills and PODs to shipments.
- **Future Tasks:**
  - Implement configurable PO approval workflows.
  - Build out more specific, granular reports in the Reporting module.
  - Implement a full, immutable audit trail for all critical transactions.

**Completed work in this session**
- **Admin-Only Deletion:** Implemented and tested admin-only delete buttons on all data pages.
- **Payments Module Overhaul:**
    - Implemented Internal/External payment types with conditional forms for Vendor vs. CC payments.
    - Fixed a critical bug in payment balance calculation for legacy data.
    - Added a feature to view all external payments linked to an internal payment PO.
- **IMEI Inventory Enhancements:**
    - Fixed IMEI not found bug by adding a lookup from procurement records.
    - Implemented auto-population of vendor, location, brand, model, and colour when an IMEI is entered.
    - Redesigned the form to remove the 'Organization' field and add the new auto-populated fields.
- **Invoice Module Revamp:**
    - Redesigned the Create Invoice form to be manual, removing PO dependency.
    - Added dynamic GST calculation with selectable slabs (5%, 12%, 18%).
    - Created a professional, printable invoice template accessible by clicking the invoice number.
- **Reports Page Deletion:** Added functionality to delete the source Purchase Order directly from the Master Report page.
- **UI/UX:** Reordered the sidebar navigation as per user request and removed the Sales Orders link.

**Code Architecture**


**Key Technical Concepts**
-   **Backend:** FastAPI
-   **Frontend:** React, Tailwind CSS, Shadcn UI
-   **Database:** MongoDB
-   **Authentication:** JWT (JSON Web Tokens)
-   **State Management:** React Hooks (, , )
-   **Frontend Logic:** Conditional rendering for dynamic forms, client-side data fetching and state updates.

**key DB schema**
-   **invoices**: Schema updated to include , , , .
-   **imei_inventory**: Schema updated to include , , .
-   **purchase_orders**, **procurement**, **logistics_shipments**, **payments**: Schemas remain largely the same but are now interlinked via cascade delete logic originating from .

**All files of reference**
-   : Heavily modified with new endpoints (, ), cascade-delete logic, and updates to models and create/read endpoints for Payments and Invoices.
-   : Completely rewritten to support the new payment flow, dynamic forms, and linked-payment modal.
-   : Completely rewritten to support IMEI lookup and auto-population of fields.
-   : Completely rewritten to support the new manual invoice form, GST calculation, and printable invoice template.
-   : Modified to add the cascade-delete confirmation dialog.
-   : Modified to add delete functionality.
-   : Modified to reorder navigation links and remove Sales Orders.

**Areas that need refactoring**
-   ****: This is the highest priority. The file is now dangerously large and contains all models, business logic, and endpoints. It must be broken down into a modular structure (, , ) for maintainability.

**key api endpoints**
-   : **(Updated)** Now triggers a cascade delete of related procurement, payment, logistics, and inventory records.
-   : **(Updated)** Modified to accept new fields like  and no longer requires a .
-   : **(Updated)** Logic improved to correctly handle legacy internal payments during validation.
-   : **(Updated)** Logic improved to correctly calculate sums for legacy internal payments.
-   : **(Updated)** Now creates an inventory record if the IMEI exists in procurement but not yet in inventory.
-   : **(New)** Looks up an IMEI in procurement and POs to return vendor, brand, model, and color details.
-   : **(New)** Returns counts of records linked to a specific PO.

**Critical Info for New Agent**
-   The most critical task is to complete and thoroughly test the data integrity feature. This involves not just the cascade delete but ensuring the entire UI (dashboards, dropdowns) reflects these changes in real-time or upon refresh.
-   The backend  is a major source of technical debt. Any significant new backend feature should be preceded by or bundled with the refactoring of this file.
-   The user is focused on making the application behave like a reliable, real-world system. Emphasize data consistency and accurate reflections of state in all future work.

**documents and test reports created in this job**
-   

**Last 10 User Messages and any pending HUMAN messages**
1.  **Request (In Progress):** Make the application data-aware and reliable with cascade deletes and real-time updates.
2.  **Request (Completed):** Overhaul the Invoices page: remove PO dependency, add manual fields, implement GST calculation with percentage slabs, and create a printable invoice template.
3.  **Request (Completed):** Update the Invoices page to auto-populate billing organization based on PO and change button colors.
4.  **Request (Completed):** Reorder the sidebar navigation and remove Sales Orders.
5.  **Request (Completed):** Update the Inventory page: remove 'Organization', add and auto-populate 'Brand', 'Model', and 'Colour'.
6.  **Request (Completed):** Update the Payments page: dynamically change External Payment fields for Credit Card payee type.
7.  **Request (Completed):** Fix the IMEI not found error on the Inventory page and auto-populate vendor details on IMEI entry.
8.  **Request (Completed):** Remove test data, add a clickable PO link in Payments to show related external payments, and add a delete option to the Reports page.
9.  **Bug Report (Fixed):** The payment balance calculation was incorrect. The agent debugged and fixed the issue related to legacy data.
10. **Initial Request (Completed):** The initial multi-part task (admin delete, duplicate PO check, Payments overhaul) was fully implemented and tested.

**Project Health Check:**
-   **Broken:** The real-time update aspect of the latest user request is incomplete. The Dashboard is static, and it's unconfirmed if all UI elements (like dropdowns) update correctly after a cascade delete.
-   **Mocked:** The  page functionality is still likely a placeholder.

**3rd Party Integrations**
-   None implemented.

**Testing status**
-   **Testing agent used after significant changes:** YES, at the beginning of the session for the initial feature set.
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** None in this session.
-   **Known regressions:** The  warning persists.

**Credentials to test flow:**
Available at .
-   **Magnova Admin (Full Access):**  / 
-   **Nova Stores (Procurement/Inventory):**  / 

**What agent forgot to execute**
The agent is in the middle of implementing the user's request for data integrity and real-time updates. It has implemented the backend cascade-delete and frontend confirmation but has not yet implemented the dashboard auto-refresh or verified that all UI elements (especially dropdowns) update correctly after a deletion.</analysis>
